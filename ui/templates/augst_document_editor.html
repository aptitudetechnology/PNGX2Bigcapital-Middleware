<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Invoice {{ invoice_number }} - Australian GST Invoice System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        /* Australian GST Invoice Editor Styles */
        .invoice-editor {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 1.5rem;
            min-height: calc(100vh - 100px);
        }
        
        .invoice-preview {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            height: fit-content;
        }
        
        .invoice-form {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #059669;
        }
        
        .invoice-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #059669;
            margin: 0;
        }
        
        .invoice-number {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
        }
        
        .business-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .detail-section {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .detail-section h4 {
            margin: 0 0 0.75rem 0;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .detail-item {
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .detail-label {
            font-weight: 500;
            color: #6b7280;
            display: inline-block;
            width: 80px;
        }
        
        .detail-value {
            color: #374151;
        }
        
        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.875rem;
        }
        
        .line-items-table th,
        .line-items-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .line-items-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .line-items-table .amount {
            text-align: right;
        }
        
        .totals-section {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            margin-top: 1rem;
        }
        
        .totals-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .totals-row.total {
            font-weight: 600;
            font-size: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #d1d5db;
            color: #059669;
        }
        
        .form-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .form-section:last-child {
            border-bottom: none;
        }
        
        .form-section h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .line-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        
        .line-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .line-item-number {
            font-weight: 600;
            color: #374151;
        }
        
        .remove-line-item {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }
        
        .remove-line-item:hover {
            background: #b91c1c;
        }
        
        .add-line-item {
            background: #059669;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .add-line-item:hover {
            background: #047857;
        }
        
        .save-buttons {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .btn-save {
            background: #059669;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-save:hover {
            background: #047857;
        }
        
        .btn-cancel {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-cancel:hover {
            background: #4b5563;
        }
        
        .notification {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .notification.success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .notification.error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-draft { background: #fef3c7; color: #92400e; }
        .status-sent { background: #dbeafe; color: #1e40af; }
        .status-paid { background: #d1fae5; color: #065f46; }
        .status-overdue { background: #fee2e2; color: #991b1b; }
        .status-cancelled { background: #f3f4f6; color: #6b7280; }
        
        .gst-rate-select {
            width: 100px;
        }
        
        .amount-input {
            text-align: right;
        }
        
        @media (max-width: 1024px) {
            .invoice-editor {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .business-details {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header" style="margin-bottom: 1.5rem;">
            <div class="header-top">
                <div>
                    <h1 class="title">Edit Invoice {{ invoice_number }}</h1>
                    <p class="subtitle">Australian GST Invoice</p>
                </div>
                <button onclick="window.close()" class="btn btn-secondary">
                    <i data-feather="x"></i>
                    <span>Close</span>
                </button>
            </div>
        </div>

        <!-- Notification Area -->
        <div id="notification" class="notification"></div>

        <!-- Invoice Editor Grid -->
        <div class="invoice-editor">
            <!-- Invoice Preview -->
            <div class="invoice-preview">
                <div class="invoice-header">
                    <div>
                        <h2 class="invoice-title">TAX INVOICE</h2>
                        <p style="color: #6b7280; font-size: 0.875rem;">Australian GST Invoice</p>
                    </div>
                    <div class="invoice-number">
                        Invoice #<span id="previewInvoiceNumber">{{ invoice_number or 'NEW' }}</span>
                    </div>
                </div>

                <!-- Business Details Preview -->
                <div class="business-details">
                    <div class="detail-section">
                        <h4>From (Supplier)</h4>
                        <div class="detail-item">
                            <span class="detail-value" id="previewSupplierName">{{ supplier_name or 'Your Business Name' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ABN:</span>
                            <span class="detail-value" id="previewSupplierABN">{{ supplier_abn or '00 000 000 000' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ACN:</span>
                            <span class="detail-value" id="previewSupplierACN">{{ supplier_acn or 'N/A' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-value" id="previewSupplierAddress">{{ supplier_address or 'Business Address' }}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h4>To (Customer)</h4>
                        <div class="detail-item">
                            <span class="detail-value" id="previewCustomerName">{{ customer_name or 'Customer Name' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ABN:</span>
                            <span class="detail-value" id="previewCustomerABN">{{ customer_abn or 'N/A' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-value" id="previewCustomerAddress">{{ customer_address or 'Customer Address' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Invoice Details -->
                <div class="detail-section">
                    <div class="form-row">
                        <div class="detail-item">
                            <span class="detail-label">Date:</span>
                            <span class="detail-value" id="previewInvoiceDate">{{ invoice_date or 'TBD' }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Due:</span>
                            <span class="detail-value" id="previewDueDate">{{ due_date or 'TBD' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Line Items Preview -->
                <table class="line-items-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="text-align: center;">Qty</th>
                            <th class="amount">Unit Price</th>
                            <th class="amount">GST</th>
                            <th class="amount">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="previewLineItems">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #6b7280; font-style: italic;">
                                No line items added yet
                            </td>
                        </tr>
                    </tbody>
                </table>

                <!-- Totals Preview -->
                <div class="totals-section">
                    <div class="totals-row">
                        <span>Subtotal:</span>
                        <span id="previewSubtotal">$0.00</span>
                    </div>
                    <div class="totals-row">
                        <span>GST (10%):</span>
                        <span id="previewGST">$0.00</span>
                    </div>
                    <div class="totals-row total">
                        <span>Total:</span>
                        <span id="previewTotal">$0.00</span>
                    </div>
                </div>
            </div>

            <!-- Invoice Form -->
            <div class="invoice-form">
                <h3 class="card-title" style="margin-bottom: 1.5rem;">
                    <i data-feather="edit-3"></i>
                    Invoice Details
                </h3>

                <form id="invoiceForm">
                    <!-- Document Type & Status -->
                    <div class="form-section">
                        <h4>
                            <i data-feather="file-text"></i>
                            Document Information
                        </h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Document Type</label>
                                <select id="documentType" class="form-input" required>
                                    <option value="tax_invoice" {{ 'selected' if document_type == 'tax_invoice' else '' }}>Tax Invoice</option>
                                    <option value="adjustment_note" {{ 'selected' if document_type == 'adjustment_note' else '' }}>Adjustment Note</option>
                                    <option value="recipient_created_tax_invoice" {{ 'selected' if document_type == 'recipient_created_tax_invoice' else '' }}>Recipient Created Tax Invoice</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="status-badge status-{{ status or 'draft' }}">{{ (status or 'draft')|title }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Invoice Number</label>
                                <input type="text" id="invoiceNumber" class="form-input" 
                                       value="{{ invoice_number or '' }}" 
                                       placeholder="INV-001" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tax Period</label>
                                <input type="text" id="taxPeriod" class="form-input" 
                                       value="{{ tax_period or '' }}" 
                                       placeholder="YYYY-MM" pattern="[0-9]{4}-[0-9]{2}">
                            </div>
                        </div>
                    </div>

                    <!-- Supplier Information -->
                    <div class="form-section">
                        <h4>
                            <i data-feather="building"></i>
                            Supplier Information
                        </h4>
                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">Business Name</label>
                                <input type="text" id="supplierName" class="form-input" 
                                       value="{{ supplier_name or '' }}" 
                                       placeholder="Your Business Name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">ABN</label>
                                <input type="text" id="supplierABN" class="form-input" 
                                       value="{{ supplier_abn or '' }}" 
                                       placeholder="00 000 000 000" required 
                                       pattern="[0-9]{11}" maxlength="11">
                            </div>
                            <div class="form-group">
                                <label class="form-label">ACN (Optional)</label>
                                <input type="text" id="supplierACN" class="form-input" 
                                       value="{{ supplier_acn or '' }}" 
                                       placeholder="000 000 000" 
                                       pattern="[0-9]{9}" maxlength="9">
                            </div>
                        </div>
                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <textarea id="supplierAddress" class="form-input" rows="3" 
                                          placeholder="Business Address">{{ supplier_address or '' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Information -->
                    <div class="form-section">
                        <h4>
                            <i data-feather="user"></i>
                            Customer Information
                        </h4>
                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">Customer Name</label>
                                <input type="text" id="customerName" class="form-input" 
                                       value="{{ customer_name or '' }}" 
                                       placeholder="Customer Name" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Customer ABN</label>
                                <input type="text" id="customerABN" class="form-input" 
                                       value="{{ customer_abn or '' }}" 
                                       placeholder="00 000 000 000" 
                                       pattern="[0-9]{11}" maxlength="11">
                                <small style="color: #6b7280; font-size: 0.75rem;">
                                    Required for B2B transactions over $82.50
                                </small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Person</label>
                                <input type="text" id="customerContact" class="form-input" 
                                       value="{{ customer_contact_person or '' }}" 
                                       placeholder="Contact Name">
                            </div>
                        </div>
                        <div class="form-row full">
                            <div class="form-group">
                                <label class="form-label">Customer Address</label>
                                <textarea id="customerAddress" class="form-input" rows="3" 
                                          placeholder="Customer Address">{{ customer_address or '' }}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Dates -->
                    <div class="form-section">
                        <h4>
                            <i data-feather="calendar"></i>
                            Invoice Dates
                        </h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Invoice Date</label>
                                <input type="date" id="invoiceDate" class="form-input" 
                                       value="{{ invoice_date or '' }}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" id="dueDate" class="form-input" 
                                       value="{{ due_date or '' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Line Items -->
                    <div class="form-section">
                        <h4>
                            <i data-feather="list"></i>
                            Line Items
                        </h4>
                        <button type="button" class="add-line-item" onclick="addLineItem()">
                            <i data-feather="plus"></i>
                            Add Line Item
                        </button>
                        <div id="lineItemsContainer">
                            <!-- Line items will be added here -->
                        </div>
                    </div>

                    <!-- Payment Terms -->
                    <div class="form-section">
                        <h4>
                            <i data-feather="credit-card"></i>
                            Payment Information
                        </h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Payment Terms</label>
                                <input type="text" id="paymentTerms" class="form-input" 
                                       value="{{ payment_terms or '' }}" 
                                       placeholder="Net 30 days">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Payment Method</label>
                                <select id="paymentMethod" class="form-input">
                                    <option value="">Select method</option>
                                    <option value="bank_transfer" {{ 'selected' if payment_method == 'bank_transfer' else '' }}>Bank Transfer</option>
                                    <option value="credit_card" {{ 'selected' if payment_method == 'credit_card' else '' }}>Credit Card</option>
                                    <option value="cash" {{ 'selected' if payment_method == 'cash' else '' }}>Cash</option>
                                    <option value="cheque" {{ 'selected' if payment_method == 'cheque' else '' }}>Cheque</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="save-buttons">
                        <button type="submit" class="btn-save">
                            <i data-feather="save"></i>
                            <span>Save Invoice</span>
                        </button>
                        <button type="button" class="btn-cancel" onclick="window.close()">
                            <i data-feather="x"></i>
                            <span>Cancel</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let lineItemCounter = 0;
        let existingLineItems = {{ line_items|tojson|safe if line_items else '[]' }};

        // Initialize the invoice editor
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
        });

        function initializeEditor() {
            feather.replace();
            setupFormHandlers();
            loadExistingLineItems();
            updateAllPreviews();
        }

        function loadExistingLineItems() {
            if (existingLineItems && existingLineItems.length > 0) {
                existingLineItems.forEach(item => {
                    addLineItem(item);
                });
            } else {
                // Add one empty line item by default
                addLineItem();
            }
        }

        function addLineItem(data = null) {
            lineItemCounter++;
            const container = document.getElementById('lineItemsContainer');
            
            const lineItemHtml = `
                <div class="line-item" data-line-id="${lineItemCounter}">
                    <div class="line-item-header">
                        <span class="line-item-number">Line Item ${lineItemCounter}</span>
                        <button type="button" class="remove-line-item" onclick="removeLineItem(${lineItemCounter})">
                            <i data-feather="trash-2" size="12"></i>
                        </button>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-input line-description" 
                                   placeholder="Item description" 
                                   value="${data ? data.description || '' : ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-input line-quantity" step="0.001" min="0" 
                                   placeholder="1.000" 
                                   value="${data ? data.quantity || '1' : '1'}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unit Price</label>
                            <input type="number" class="form-input line-unit-price amount-input" step="0.01" min="0" 
                                   placeholder="0.00" 
                                   value="${data ? data.unit_price || '' : ''}" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">GST Treatment</label>
                            <select class="form-input line-gst-treatment">
                                <option value="taxable" ${data && data.gst_treatment === 'taxable' ? 'selected' : ''}>Taxable (10%)</option>
                                <option value="gst_free" ${data && data.gst_treatment === 'gst_free' ? 'selected' : ''}>GST Free</option>
                                <option value="input_taxed" ${data && data.gst_treatment === 'input_taxed' ? 'selected' : ''}>Input Taxed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Product Code</label>
                            <input type="text" class="form-input line-product-code" 
                                   placeholder="Optional" 
                                   value="${data ? data.product_code || '' : ''}">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', lineItemHtml);
            feather.replace();
            
            // Add event listeners for calculations
            const newLineItem = container.lastElementChild;
            const inputs = newLineItem.querySelectorAll('input, select');
            inputs.forEach(input => {
                input.addEventListener('input', updateCalculations);
                input.addEventListener('change', updateCalculations);
            });
            
            updateCalculations();
        }

        function removeLineItem(lineId) {
            const lineItem = document.querySelector(`[data-line-id="${lineId}"]`);
            if (lineItem) {
                lineItem.remove();
                updateCalculations();
            }
        }

        function updateCalculations() {
            let subtotal = 0;
            let gstTotal = 0;
            
            const lineItems = document.querySelectorAll('.line-item');
            
            lineItems.forEach(lineItem => {
                const quantity = parseFloat(lineItem.querySelector('.line-quantity').value) || 0;
                const unitPrice = parseFloat(lineItem.querySelector('.line-unit-price').value) || 0;
                const gstTreatment = lineItem.querySelector('.line-gst-treatment').value;
                
                const lineTotal = quantity * unitPrice;
                const gstAmount = gstTreatment === 'taxable' ? lineTotal * 0.1 : 0;
                const gstRate = gstTreatment === 'taxable' ? '10%' : '0%';
                
                html += `
                    <tr>
                        <td>${description}</td>
                        <td style="text-align: center;">${quantity}</td>
                        <td class="amount">${formatCurrency(unitPrice)}</td>
                        <td class="amount">${gstRate}</td>
                        <td class="amount">${formatCurrency(lineTotal + gstAmount)}</td>
                    </tr>
                `;
            });
            
            previewContainer.innerHTML = html;
        }

        function setupFormHandlers() {
            const form = document.getElementById('invoiceForm');
            form.addEventListener('submit', handleFormSubmit);
            
            // Add preview update listeners to all form inputs
            const formInputs = form.querySelectorAll('input, select, textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', updateAllPreviews);
                input.addEventListener('change', updateAllPreviews);
            });
        }

        function updateAllPreviews() {
            // Update basic invoice information
            document.getElementById('previewInvoiceNumber').textContent = 
                document.getElementById('invoiceNumber').value || 'NEW';
            document.getElementById('previewInvoiceDate').textContent = 
                document.getElementById('invoiceDate').value || 'TBD';
            document.getElementById('previewDueDate').textContent = 
                document.getElementById('dueDate').value || 'TBD';
            
            // Update supplier information
            document.getElementById('previewSupplierName').textContent = 
                document.getElementById('supplierName').value || 'Your Business Name';
            document.getElementById('previewSupplierABN').textContent = 
                formatABN(document.getElementById('supplierABN').value) || '00 000 000 000';
            document.getElementById('previewSupplierACN').textContent = 
                formatACN(document.getElementById('supplierACN').value) || 'N/A';
            document.getElementById('previewSupplierAddress').textContent = 
                document.getElementById('supplierAddress').value || 'Business Address';
            
            // Update customer information
            document.getElementById('previewCustomerName').textContent = 
                document.getElementById('customerName').value || 'Customer Name';
            document.getElementById('previewCustomerABN').textContent = 
                formatABN(document.getElementById('customerABN').value) || 'N/A';
            document.getElementById('previewCustomerAddress').textContent = 
                document.getElementById('customerAddress').value || 'Customer Address';
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            // Collect line items data
            const lineItemsData = [];
            const lineItems = document.querySelectorAll('.line-item');
            
            lineItems.forEach((lineItem, index) => {
                const description = lineItem.querySelector('.line-description').value;
                const quantity = parseFloat(lineItem.querySelector('.line-quantity').value) || 0;
                const unitPrice = parseFloat(lineItem.querySelector('.line-unit-price').value) || 0;
                const gstTreatment = lineItem.querySelector('.line-gst-treatment').value;
                const productCode = lineItem.querySelector('.line-product-code').value;
                
                const lineTotal = quantity * unitPrice;
                const gstAmount = gstTreatment === 'taxable' ? lineTotal * 0.1 : 0;
                const gstRate = gstTreatment === 'taxable' ? 10.00 : 0.00;
                
                if (description && quantity > 0 && unitPrice >= 0) {
                    lineItemsData.push({
                        line_number: index + 1,
                        description: description,
                        quantity: quantity,
                        unit_price: unitPrice,
                        line_total: lineTotal,
                        gst_rate: gstRate,
                        gst_amount: gstAmount,
                        gst_treatment: gstTreatment,
                        product_code: productCode || null
                    });
                }
            });
            
            // Calculate totals
            const subtotal = lineItemsData.reduce((sum, item) => sum + item.line_total, 0);
            const gstTotal = lineItemsData.reduce((sum, item) => sum + item.gst_amount, 0);
            const total = subtotal + gstTotal;
            
            const formData = {
                document_type: document.getElementById('documentType').value,
                invoice_number: document.getElementById('invoiceNumber').value,
                invoice_date: document.getElementById('invoiceDate').value,
                due_date: document.getElementById('dueDate').value || null,
                tax_period: document.getElementById('taxPeriod').value || null,
                
                // Supplier information
                supplier_name: document.getElementById('supplierName').value,
                supplier_abn: document.getElementById('supplierABN').value.replace(/\s/g, ''),
                supplier_acn: document.getElementById('supplierACN').value.replace(/\s/g, '') || null,
                supplier_address: document.getElementById('supplierAddress').value || null,
                
                // Customer information
                customer_name: document.getElementById('customerName').value,
                customer_abn: document.getElementById('customerABN').value.replace(/\s/g, '') || null,
                customer_address: document.getElementById('customerAddress').value || null,
                customer_contact_person: document.getElementById('customerContact').value || null,
                
                // Financial totals
                subtotal_amount: subtotal,
                gst_amount: gstTotal,
                total_amount: total,
                
                // Payment information
                payment_terms: document.getElementById('paymentTerms').value || null,
                payment_method: document.getElementById('paymentMethod').value || null,
                
                // Line items
                line_items: lineItemsData
            };

            try {
                const response = await fetch(`/api/invoice/{{ id or 'new' }}/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Invoice saved successfully!', 'success');
                    
                    // Update the invoice number in preview if it was auto-generated
                    if (result.invoice_number) {
                        document.getElementById('invoiceNumber').value = result.invoice_number;
                        document.getElementById('previewInvoiceNumber').textContent = result.invoice_number;
                    }
                    
                    // Optionally close the window after a delay
                    setTimeout(() => {
                        if (confirm('Invoice saved successfully. Close this window?')) {
                            window.close();
                        }
                    }, 1500);
                } else {
                    showNotification('Error: ' + (result.error || 'Failed to save invoice'), 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showNotification('Error: Failed to communicate with server', 'error');
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-AU', {
                style: 'currency',
                currency: 'AUD'
            }).format(amount || 0);
        }

        function formatABN(abn) {
            if (!abn) return '';
            const cleaned = abn.replace(/\s/g, '');
            if (cleaned.length === 11) {
                return cleaned.replace(/(\d{2})(\d{3})(\d{3})(\d{3})/, '$1 $2 $3 $4');
            }
            return abn;
        }

        function formatACN(acn) {
            if (!acn) return '';
            const cleaned = acn.replace(/\s/g, '');
            if (cleaned.length === 9) {
                return cleaned.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
            }
            return acn;
        }

        // Handle form change tracking
        let formChanged = false;
        
        document.addEventListener('input', function() {
            formChanged = true;
        });

        window.addEventListener('beforeunload', function(event) {
            if (formChanged) {
                event.preventDefault();
                event.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return event.returnValue;
            }
        });

        // Reset form changed flag when form is submitted
        document.getElementById('invoiceForm').addEventListener('submit', function() {
            formChanged = false;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Ctrl+S or Cmd+S to save
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                document.getElementById('invoiceForm').dispatchEvent(new Event('submit'));
            }
            
            // Escape to close
            if (event.key === 'Escape') {
                if (confirm('Close this window?')) {
                    window.close();
                }
            }
            
            // Ctrl+L or Cmd+L to add line item
            if ((event.ctrlKey || event.metaKey) && event.key === 'l') {
                event.preventDefault();
                addLineItem();
            }
        });

        // Auto-save draft functionality (optional)
        let autoSaveTimeout;
        document.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(function() {
                // Could implement auto-save draft here
                console.log('Auto-save draft (not implemented)');
            }, 30000); // Auto-save after 30 seconds of inactivity
        });

        // ABN validation
        function validateABN(abn) {
            const cleaned = abn.replace(/\s/g, '');
            if (cleaned.length !== 11 || !/^\d+$/.test(cleaned)) {
                return false;
            }
            
            // Australian ABN validation algorithm
            const weights = [10, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19];
            let sum = 0;
            
            for (let i = 0; i < 11; i++) {
                sum += parseInt(cleaned[i]) * weights[i];
            }
            
            return (sum % 89) === 0;
        }

        // Add ABN validation to form inputs
        document.getElementById('supplierABN').addEventListener('blur', function() {
            const abn = this.value.replace(/\s/g, '');
            if (abn && !validateABN(abn)) {
                showNotification('Invalid Supplier ABN format', 'error');
            }
        });

        document.getElementById('customerABN').addEventListener('blur', function() {
            const abn = this.value.replace(/\s/g, '');
            if (abn && !validateABN(abn)) {
                showNotification('Invalid Customer ABN format', 'error');
            }
        });

        // Format ABN as user types
        document.getElementById('supplierABN').addEventListener('input', function() {
            this.value = formatABN(this.value);
        });

        document.getElementById('customerABN').addEventListener('input', function() {
            this.value = formatABN(this.value);
        });

        // Format ACN as user types
        document.getElementById('supplierACN').addEventListener('input', function() {
            this.value = formatACN(this.value);
        });
    </script>

</body>
</html> = parseFloat(lineItem.querySelector('.line-unit-price').value) || 0;
                const gstTreatment = lineItem.querySelector('.line-gst-treatment').value;
                
                const lineTotal = quantity * unitPrice;
                const gstAmount = gstTreatment === 'taxable' ? lineTotal * 0.1 : 0;
                
                subtotal += lineTotal;
                gstTotal += gstAmount;
            });
            
            const total = subtotal + gstTotal;
            
            // Update preview
            document.getElementById('previewSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('previewGST').textContent = formatCurrency(gstTotal);
            document.getElementById('previewTotal').textContent = formatCurrency(total);
            
            updateLineItemsPreview();
        }

        function updateLineItemsPreview() {
            const previewContainer = document.getElementById('previewLineItems');
            const lineItems = document.querySelectorAll('.line-item');
            
            if (lineItems.length === 0) {
                previewContainer.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #6b7280; font-style: italic;">
                            No line items added yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            lineItems.forEach((lineItem, index) => {
                const description = lineItem.querySelector('.line-description').value || 'Untitled Item';
                const quantity = parseFloat(lineItem.querySelector('.line-quantity').value) || 0;
                const unitPrice
